<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BYZ Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --bg-alt:#f5f5f7;
      --bg-elev:#ffffff;
      --text:#1d1d1f;
      --sub:#6e6e73;
      --border:#d2d2d7;
      --accent:#007aff;
      --accent-hover:#0051d5;

      --radius: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --shadow: 0 4px 16px rgba(0,0,0,.08);
      --shadow-soft: 0 2px 8px rgba(0,0,0,.04);
      --shadow-hover: 0 8px 24px rgba(0,0,0,.12);
      --ease: cubic-bezier(.25,.46,.45,.94);
      --ease-bounce: cubic-bezier(.68,-0.55,.265,1.55);
      --max: 1200px;
      --header-h: 64px;

      --ok:#30d158;
      --ok-light:#d1fae5;
      --warn:#ff9f0a;
      --warn-light:#fef3c7;
      --bad:#ff453a;
      --bad-light:#fee2e2;
      --info:#5ac8fa;
      --info-light:#dbeafe;
    }

    [data-theme="dark"]{
      --bg:#000000;
      --bg-alt:#1c1c1e;
      --bg-elev:#2c2c2e;
      --text:#f5f5f7;
      --sub:#98989d;
      --border:#38383a;
      --accent:#0a84ff;
      --accent-hover:#409cff;
      --shadow: 0 4px 16px rgba(0,0,0,.3);
      --shadow-soft: 0 2px 8px rgba(0,0,0,.2);
      --shadow-hover: 0 8px 24px rgba(0,0,0,.4);
      --ok:#32d74b;
      --ok-light:rgba(48,209,88,.15);
      --warn:#ff9f0a;
      --warn-light:rgba(255,159,10,.15);
      --bad:#ff453a;
      --bad-light:rgba(255,69,58,.15);
      --info:#64d2ff;
      --info-light:rgba(90,200,250,.15);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Helvetica Neue",Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
      transition: background .4s var(--ease), color .4s var(--ease);
      overflow-x:hidden;
      position:relative;
    }
    body::before{
      content:"";
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(0,122,255,.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(0,122,255,.02) 0%, transparent 50%);
      pointer-events:none;
      z-index:0;
    }
    [data-theme="dark"] body::before{
      background: 
        radial-gradient(circle at 20% 30%, rgba(10,132,255,.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(10,132,255,.05) 0%, transparent 50%);
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--max);margin:0 auto;padding:0 32px;position:relative;z-index:1}

    header{
      position: sticky;
      top: 0;
      height:var(--header-h);
      background: color-mix(in srgb, var(--bg) 80%, transparent);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom:0.5px solid var(--border);
      z-index:999;
    }

    .header-inner{
      height:var(--header-h);
      display:flex;align-items:center;justify-content:space-between;
      gap:20px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:600;letter-spacing:-.3px;
      font-size:17px;
      transition: opacity .2s var(--ease);
    }
    .brand:hover{opacity:.8;}
    .brand-logo-wrap{
      width:32px;height:32px;border-radius:8px;
      overflow:hidden;display:grid;place-items:center;
      transition: transform .2s var(--ease);
    }
    .brand:hover .brand-logo-wrap{
      transform: scale(1.05);
    }
    .brand-logo{width:100%;height:100%;object-fit:contain;display:block}
    .logo-dark{display:none;}
    [data-theme="dark"] .logo-light{display:none;}
    [data-theme="dark"] .logo-dark{display:block;}

    .top-actions{display:flex;align-items:center;gap:8px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 14px;border-radius:8px;
      font-size:13px;
      font-weight:500;
      color:var(--sub);
      transition: all .2s var(--ease);
    }
    .pill:hover{
      color:var(--text);
      background: color-mix(in srgb, var(--bg-alt) 50%, transparent);
    }
    .pill i{font-size:12px;}
    .theme-btn{
      width:32px;height:32px;border-radius:8px;
      background: transparent;
      border:none;
      display:grid;place-items:center;
      cursor:pointer;
      transition: all .2s var(--ease);
      color:var(--sub);
    }
    .theme-btn:hover{
      background: color-mix(in srgb, var(--bg-alt) 50%, transparent);
      color:var(--text);
    }
    .theme-btn i{font-size:16px;}

    main{padding-top: 24px; padding-bottom: 80px;position:relative;z-index:1;}
    
    /* Main Tab Navigation */
    .main-tabs{
      display:flex;
      gap:8px;
      margin-bottom:24px;
      border-bottom:0.5px solid var(--border);
      padding-bottom:0;
    }
    .main-tab-btn{
      padding:12px 20px;
      font-size:15px;
      font-weight:500;
      color:var(--sub);
      background:transparent;
      border:none;
      border-bottom:2px solid transparent;
      cursor:pointer;
      transition: all .2s var(--ease);
      position:relative;
      margin-bottom:-0.5px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .main-tab-btn i{
      font-size:14px;
    }
    .main-tab-btn:hover{
      color:var(--text);
    }
    .main-tab-btn.active{
      color:var(--accent);
      border-bottom-color:var(--accent);
    }
    
    /* View Containers */
    .view-container{
      display:none;
    }
    .view-container.active{
      display:block;
      animation:fadeIn .3s var(--ease);
    }
    @keyframes fadeIn{
      from{opacity:0;}
      to{opacity:1;}
    }
    
    .card{
      border-radius: var(--radius-lg);
      background: var(--bg-elev);
      border:0.5px solid var(--border);
      overflow:hidden;
    }

    .card{
      border-radius: var(--radius-xl);
      border:1px solid var(--border);
      background: var(--bg-elev);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      transition: transform .3s var(--ease), box-shadow .3s var(--ease);
    }
    .card::before{
      content:"";
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:4px;
      background: var(--accent-grad);
      opacity:0;
      transition: opacity .3s var(--ease);
    }
    .card:hover::before{opacity:1;}
    .card-head{
      padding: 28px 28px 0;
    }
    .card-head h1{
      font-size: clamp(28px, 4vw, 36px);
      letter-spacing: -0.8px;
      line-height: 1.15;
      font-weight:700;
      color:var(--text);
      margin-bottom:6px;
    }
    .card-head p{
      margin-top:2px;
      color:var(--sub);
      font-size:15px;
      font-weight:400;
    }
    .card-body{padding: 28px}

    .login-wrap{
      min-height: calc(100vh - var(--header-h) - 32px);
      display:grid;
      place-items:center;
      position:relative;
    }
    .login-box{
      width: min(420px, 100%);
      border-radius: var(--radius-lg);
      border:0.5px solid var(--border);
      background: var(--bg-elev);
      box-shadow: var(--shadow);
      padding: 0;
      position:relative;
    }
    .login-inner{
      padding: 40px;
    }
    .lock-row{
      display:flex;align-items:flex-start;gap:16px;
      margin-bottom: 28px;
    }
    .lock-icon{
      width:48px;height:48px;border-radius:12px;
      display:grid;place-items:center;
      background: var(--accent);
      flex-shrink:0;
      transition: transform .2s var(--ease);
    }
    .lock-icon:hover{transform: scale(1.05);}
    .lock-icon i{font-size:20px;color:#ffffff;}
    .login-inner h2{
      font-size:22px;
      letter-spacing:-.4px;
      font-weight:600;
      margin-bottom:4px;
      color:var(--text);
    }
    .login-inner .sub{
      color:var(--sub);
      font-size:14px;
      font-weight:400;
    }

    input, select{
      width:100%;
      padding:12px 16px;
      border-radius: 10px;
      border:0.5px solid var(--border);
      background: var(--bg-alt);
      color: var(--text);
      outline: none;
      font-size:15px;
      font-weight:400;
      transition: all .2s var(--ease);
      font-family:inherit;
    }
    input:focus, select:focus{
      border-color: var(--accent);
      background: var(--bg-elev);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 15%, transparent);
    }
    input::placeholder{color:var(--sub);opacity:.6;}
    button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 16px;
      border-radius: 10px;
      border:none;
      background: var(--bg-alt);
      color: var(--text);
      font-weight:500;
      font-size:14px;
      cursor:pointer;
      transition: all .2s var(--ease);
      font-family:inherit;
    }
    button:hover{
      background: var(--bg-elev);
      transform: translateY(-1px);
    }
    button:active{transform: translateY(0) scale(.98);}
    .primary{
      background: var(--accent);
      color: #ffffff;
    }
    .primary:hover{
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    .full{width:100%; margin-top: 20px;}
    .hidden{display:none}

    .dash-grid{display:grid;grid-template-columns:1fr;gap:16px;}
#dashboard{
  scroll-margin-top: calc(var(--header-h) + 16px);
}

    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:16px;
      margin-top: 24px;
    }
    @media (max-width: 980px){ .stats{grid-template-columns:1fr 1fr;} }
    @media (max-width: 560px){ .stats{grid-template-columns:1fr;} }

    .stat{
      border-radius: var(--radius);
      border:0.5px solid var(--border);
      background: var(--bg-elev);
      padding: 20px;
      transition: all .2s var(--ease);
    }
    .stat:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .stat .k{
      color:var(--sub);
      font-size:12px;
      font-weight:500;
      margin-bottom:8px;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .stat .v{
      font-size:28px;
      font-weight:700;
      letter-spacing:-1px;
      margin-top:4px;
      color:var(--text);
    }

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:20px;
    }
    .tab-btn{
      padding:8px 16px;border-radius:8px;border:none;
      background: var(--bg-alt);
      font-weight:500;font-size:14px;cursor:pointer;
      transition: all .2s var(--ease);
      color:var(--sub);
    }
    .tab-btn:hover{
      background: var(--bg-elev);
      color:var(--text);
    }
    .tab-btn.active{
      background: var(--accent);
      color: #ffffff;
    }

    .toolbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;flex-wrap:wrap;margin-top: 24px;
    }
    .filters{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;
      flex:1;
      min-width:200px;
    }
    .filters input, .filters select{
      flex:1;
      min-width:200px;
    }

    .table-wrap{
      margin-top: 24px;
      border-radius: var(--radius-lg);
      border:1px solid var(--border);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: var(--bg-elev);
    }
    table{width:100%;border-collapse:collapse;min-width: 1100px;}
    thead th{
      position: sticky;top: 0;
      background: color-mix(in srgb, var(--bg-elev) 98%, transparent);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border-bottom:2px solid var(--border);
      font-size: 11px;
      letter-spacing:.1em;
      text-transform: uppercase;
      color: var(--sub);
      padding: 18px 16px;
      text-align:left;
      font-weight:700;
      z-index:10;
    }
    tbody td{
      padding: 18px 16px;
      border-bottom:1px solid var(--border);
      font-size: 14px;
      vertical-align: middle;
      font-weight:500;
      transition: background .2s var(--ease);
    }
    tbody td:last-child{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    tbody td button{
      padding:8px 14px;
      font-size:12px;
      white-space:nowrap;
    }
    tbody tr{
      transition: all .2s var(--ease);
    }
    tbody tr:nth-child(even){
      background: color-mix(in srgb, var(--bg-alt) 30%, transparent);
    }
    tbody tr:hover{
      background: color-mix(in srgb, var(--bg-alt) 70%, transparent);
      transform: scale(1.001);
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }
    .scroll{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      max-height: 70vh;
    }
    .scroll::-webkit-scrollbar{
      width:8px;
      height:8px;
    }
    .scroll::-webkit-scrollbar-track{
      background:var(--bg-alt);
    }
    .scroll::-webkit-scrollbar-thumb{
      background:var(--border);
      border-radius:4px;
    }
    .scroll::-webkit-scrollbar-thumb:hover{
      background:var(--sub);
    }

    .status{
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:6px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .status::before{
      content:"";
      width:6px;
      height:6px;
      border-radius:50%;
      display:inline-block;
    }
    .PENDING{
      color: var(--warn);
      background: var(--warn-light);
    }
    .PENDING::before{background:var(--warn);}
    .CONFIRMED{
      color: var(--ok);
      background: var(--ok-light);
    }
    .CONFIRMED::before{background:var(--ok);}
    .REJECTED{
      color: var(--bad);
      background: var(--bad-light);
    }
    .REJECTED::before{background:var(--bad);}

    .approve{
      background:var(--ok-light);
      color:var(--ok);
      font-weight:500;
      font-size:13px;
      padding:8px 14px;
    }
    .approve:hover{
      background:var(--ok);
      color:#ffffff;
    }
    .reject{
      background:var(--bad-light);
      color:var(--bad);
      font-weight:500;
      font-size:13px;
      padding:8px 14px;
    }
    .reject:hover{
      background:var(--bad);
      color:#ffffff;
    }

    /* Scan panel */
    .scan{
      border-radius: var(--radius-lg);
      border:0.5px solid var(--border);
      background: var(--bg-elev);
      padding:28px;
    }
    .scan-top{
      display:flex;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .scan-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-radius:6px;
      background: var(--accent);
      color: #ffffff;
      font-size:12px;
      font-weight:500;
      width:fit-content;
    }
    .scan-h{
      font-size:28px;
      font-weight:700;
      letter-spacing:-0.8px;
      margin-top:12px;
      color:var(--text);
    }
    .scan-sub{
      color:var(--sub);
      font-size:14px;
      margin-top:6px;
      font-weight:400;
    }
    .scan-actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .scan-grid{
      margin-top: 24px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:20px;
      position:relative;
      z-index:1;
    }
    @media (max-width: 980px){ .scan-grid{grid-template-columns:1fr;} }
    .scan-video{
      border-radius: var(--radius);
      border:0.5px solid var(--border);
      background: #000;
      overflow:hidden;
      position:relative;
      min-height: 320px;
    }
    #cam{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      background:#000;
    }
    .scan-hint{
      position:absolute;
      left:16px;
      bottom:16px;
      padding:10px 14px;
      border-radius:8px;
      background: color-mix(in srgb, var(--bg-elev) 95%, transparent);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      color: var(--text);
      font-size:13px;
      font-weight:500;
      border:0.5px solid var(--border);
    }
    .scan-side{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .scan-manual{
      border-radius: var(--radius);
      border:0.5px solid var(--border);
      background: var(--bg-elev);
      padding: 20px;
    }
    .scan-manual .k{
      color:var(--sub);
      font-size:12px;
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:.3px;
      margin-bottom:12px;
    }
    .scan-manual .row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .scan-manual input{
      margin-top:0;
      flex:1;
      min-width:200px;
    }
    .scan-result{
      border-radius: var(--radius);
      border:0.5px solid var(--border);
      background: var(--bg-elev);
      padding: 20px;
    }
    .scan-result .big{
      font-size:22px;
      font-weight:700;
      letter-spacing:-.6px;
      margin-bottom:6px;
      color:var(--text);
    }
    .scan-result .sub{
      margin-top:2px;
      color:var(--sub);
      font-size:14px;
      font-weight:400;
    }
    .scan-result .meta{
      margin-top:16px;
      color:var(--sub);
      font-size:13px;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-top:16px;
      border-top:0.5px solid var(--border);
    }
    .scan-result .meta div{
      display:flex;
      gap:8px;
    }
    .scan-result .meta b{
      color:var(--text);
      font-weight:500;
      min-width:80px;
    }
    .scan-cta{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .scan-cta button{
      flex:1;
      min-width:120px;
    }
    .scan-cta button:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none !important;
    }
  </style>
</head>

<body data-theme="dark">
  <header>
    <div class="container header-inner">
      <a class="brand" href="./index.html" aria-label="BYZ Home">
        <span class="brand-logo-wrap" aria-hidden="true">
          <img class="brand-logo logo-light" src="assets/byz-logo-black.png" alt="" />
          <img class="brand-logo logo-dark"  src="assets/byz-logo-white.png" alt="" />
        </span>
      </a>

      <div class="top-actions">
        <a class="pill" href="./index.html"><i class="fa-solid fa-house"></i> Home</a>
        <button class="theme-btn" onclick="toggleTheme()" aria-label="Toggle theme" title="Toggle theme">
          <i class="fa-solid fa-circle-half-stroke"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- LOGIN -->
    <div id="login" class="login-wrap">
      <div class="login-box">
        <div class="login-inner">
          <div class="lock-row">
            <div class="lock-icon"><i class="fa-solid fa-lock"></i></div>
            <div>
              <h2>Secure access</h2>
              <div class="sub">Enter admin password to view live bookings.</div>
            </div>
          </div>

          <input id="password" type="password" placeholder="Admin password" autocomplete="current-password">
          <button class="primary full" onclick="login()">
            <i class="fa-solid fa-arrow-right-to-bracket"></i>
            Enter Dashboard
          </button>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="dash-grid hidden">
      <!-- Main Tab Navigation -->
      <div class="main-tabs">
        <button class="main-tab-btn active" onclick="switchView('dashboard-view')">
          <i class="fa-solid fa-table-cells-large"></i> Dashboard
        </button>
        <button class="main-tab-btn" onclick="switchView('scan-view')">
          <i class="fa-solid fa-qrcode"></i> Scan Mode
        </button>
      </div>

      <!-- Dashboard View -->
      <div id="dashboard-view" class="view-container active">
        <section class="card">
          <div class="card-head">
            <h1>BYZ Admin Control Center</h1>
            <p>Approvals, check‑ins, and live activity by event.</p>

          <div class="stats">
            <div class="stat"><div class="k">Total</div><div class="v" id="statTotal">—</div></div>
            <div class="stat"><div class="k">Pending</div><div class="v" id="statPending">—</div></div>
            <div class="stat"><div class="k">Confirmed</div><div class="v" id="statConfirmed">—</div></div>
            <div class="stat"><div class="k">Checked‑in</div><div class="v" id="statCheckedIn">—</div></div>
          </div>

          <div class="tabs">
            <button class="tab-btn active" data-event="">All</button>
            <button class="tab-btn" data-event="groove">Groove</button>
            <button class="tab-btn" data-event="tempo">Tempo</button>
            <button class="tab-btn" data-event="apt">APT</button>
          </div>

          <div class="toolbar">
            <div class="filters">
              <input id="search" placeholder="Search name / booking ID / phone" oninput="render()">
              <select id="statusFilter" onchange="render()">
                <option value="">All</option>
                <option value="PENDING">Pending</option>
                <option value="CONFIRMED">Confirmed</option>
                <option value="REJECTED">Rejected</option>
              </select>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="primary" onclick="load()">
                <i class="fa-solid fa-rotate"></i>
                Refresh
              </button>
              <button onclick="exportCsv()">
                <i class="fa-solid fa-file-csv"></i>
                Export CSV
              </button>
            </div>
          </div>
            <div class="scan-top">
              <div class="scan-title">
                <div class="scan-badge"><i class="fa-solid fa-sparkles"></i> Door Check‑in</div>
                <div class="scan-h">Scan booking QR</div>
                <div class="scan-sub">Choose event, scan QR, check in 1 or all</div>
              </div>

              <div class="scan-actions">
                <select id="scanEvent">
                  <option value="groove">Groove</option>
                  <option value="tempo">Tempo</option>
                  <option value="apt">APT</option>
                </select>
                <button onclick="startScan()" class="primary">
                  <i class="fa-solid fa-camera"></i> Start Camera
                </button>
                <button onclick="stopScan()">
                  <i class="fa-solid fa-circle-stop"></i> Stop
                </button>
              </div>
            </div>

            <div class="scan-grid">
              <div class="scan-video">
                <video id="cam" playsinline muted></video>
                <canvas id="scanCanvas" class="hidden"></canvas>
                <div class="scan-hint" id="scanHint">Point camera at the QR code</div>
              </div>

              <div class="scan-side">
                <div class="scan-manual">
                  <div class="k">Manual Booking ID</div>
                  <div class="row">
                    <input id="manualBid" placeholder="e.g., BYZ-GROOVE-TICKET-XXXX" />
                    <button class="primary" onclick="verifyById(manualBid.value)">
                      <i class="fa-solid fa-magnifying-glass"></i> Verify
                    </button>
                  </div>
                </div>

                <div id="scanResult" class="scan-result">
                  <div class="big">Ready</div>
                  <div class="sub">Scan a QR or search a Booking ID.</div>
                </div>

                <div class="scan-cta">
                  <button id="btnOne" class="primary" onclick="checkIn(1)" disabled>
                    <i class="fa-solid fa-right-to-bracket"></i> Check in 1
                  </button>
                  <button id="btnAll" onclick="checkIn('all')" disabled>
                    <i class="fa-solid fa-people-group"></i> Check in all
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

          <div class="card-body">
            <div class="table-wrap">
              <div class="scroll">
                <table>
                  <thead>
                    <tr>
                      <th>Event</th>
                      <th>Booking ID</th>
                      <th>Type</th>
                      <th>Description</th>
                      <th>Name</th>
                      <th>Phone</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="rows"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Scan Mode View -->
      <div id="scan-view" class="view-container">
        <section class="card">
          <div class="card-head">
            <h1>Scan Mode</h1>
            <p>Door check‑in with QR code scanning.</p>
          </div>
          <div class="card-body">
            <div id="scanPanel" class="scan">
  </main>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxl8qg5fxw8yWZJj-R98x0V0nBALjQv66xuJLiom5rkEh_BpYtZRrMcFlYkjxAOq6UC/exec";
    const ADMIN_PASSWORD = "weballwithbyz";

    let bookings = [];
    let currentEvent = "";

    (function initTheme(){
      const saved = localStorage.getItem("byz_theme");
      if(saved === "dark"){ document.body.setAttribute("data-theme","dark"); }
      else { document.body.setAttribute("data-theme","dark"); } // Default to dark
    })();

    function switchView(viewId){
      // Hide all views
      document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
      // Show selected view
      document.getElementById(viewId).classList.add('active');
      // Update tab buttons
      document.querySelectorAll('.main-tab-btn').forEach(btn => btn.classList.remove('active'));
      const clickedBtn = event ? event.target.closest('.main-tab-btn') : document.querySelector(`[onclick*="${viewId}"]`);
      if(clickedBtn) clickedBtn.classList.add('active');
      
      // If switching to scan view, ensure scan panel is visible
      if(viewId === 'scan-view'){
        document.getElementById('scanPanel').classList.remove('hidden');
      }
    }

    function toggleTheme(){
      const isDark = document.body.getAttribute("data-theme") === "dark";
      document.body.setAttribute("data-theme", isDark ? "light" : "dark");
      localStorage.setItem("byz_theme", isDark ? "light" : "dark");
    }

    function login(){
  if(password.value === ADMIN_PASSWORD){
    document.getElementById("login").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");

        // ensure scrolling works + jump to top (below fixed header)
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
    
    requestAnimationFrame(() => {
      const dash = document.getElementById("dashboard");
      if(dash){
        dash.scrollIntoView({ behavior: "auto", block: "start" });
      } else {
            window.scrollTo({ top: 0, behavior: "auto" });
      }
    });



    load();
  } else {
    alert("Incorrect password");
  }
}


    async function load(){
      try{
        const url = currentEvent ? `${SCRIPT_URL}?event=${currentEvent}` : SCRIPT_URL;
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json();

        bookings = Array.isArray(data.bookings) ? data.bookings : [];
        render();

      }catch(err){
        console.error(err);
        alert("Failed to load bookings");
      }
    }

    function render(){
      const q = search.value.toLowerCase();
      const status = statusFilter.value;
      rows.innerHTML="";

      const filtered = bookings.filter(b =>
        (!status || b.status === status) &&
        (!q ||
          (b.name||"").toLowerCase().includes(q) ||
          (b.bookingId||"").toLowerCase().includes(q) ||
          (b.phone||"").toLowerCase().includes(q)
        )
      );

      const total = filtered.length;
      const pending = filtered.filter(b => b.status === "PENDING").length;
      const confirmed = filtered.filter(b => b.status === "CONFIRMED").length;
      const checkedIn = filtered.reduce((s,b)=> s + (Number(b.checkedInCount)||0), 0);

      statTotal.textContent = total;
      statPending.textContent = pending;
      statConfirmed.textContent = confirmed;
      statCheckedIn.textContent = checkedIn;

      filtered.forEach(b=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${(b.eventKey||"").toUpperCase()}</td>
          <td>${b.bookingId}</td>
          <td>${b.bookingType}</td>
          <td>${b.description}</td>
          <td>${b.name}</td>
          <td>${b.phone}</td>
          <td>${b.amount || "-"}</td>
          <td class="status ${b.status}">${b.status}</td>
          <td>
            ${b.status==="PENDING"
              ? `<button class="approve" onclick="approve('${b.bookingId}','${b.eventKey}')">Approve</button>
                 <button class="reject" onclick="rejectBooking('${b.bookingId}','${b.eventKey}')">Reject</button>`
              : `<button onclick="resend('${b.bookingId}','${b.eventKey}')">Resend</button>`
            }
          </td>
        `;
        rows.appendChild(tr);
      });
    }

    async function approve(id, eventKey){
      if(!confirm("Approve this payment?")) return;
      try{
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action:"approvePayment", bookingId:id, pin: ADMIN_PASSWORD, eventKey })
        }).then(r=>r.json());

        if(!res.success){
          return alert("Approve failed:\n" + (res.error || "Unknown"));
        }
        alert("Approved ✅");
        load();
      }catch(err){
        console.error(err);
        alert("Approve failed.");
      }
    }

    async function rejectBooking(id, eventKey){
      if(!confirm("Reject this booking?")) return;
      try{
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action:"rejectBooking", bookingId:id, pin: ADMIN_PASSWORD, eventKey })
        }).then(r=>r.json());

        if(!res.success){
          return alert("Reject failed:\n" + (res.error || "Unknown"));
        }
        alert("Rejected ✅");
        load();
      }catch(err){
        console.error(err);
        alert("Reject failed.");
      }
    }

    async function resend(id, eventKey){
      try{
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action:"approvePayment", bookingId:id, pin: ADMIN_PASSWORD, eventKey, resend:true })
        }).then(r=>r.json());

        if(!res.success){
          return alert("Resend failed:\n" + (res.error || "Unknown"));
        }
        alert("Resent ✅");
      }catch(err){
        console.error(err);
        alert("Resend failed.");
      }
    }

    function exportCsv(){
      const rows = [["Event","Booking ID","Type","Description","Name","Phone","Amount","Status"]];
      bookings.forEach(b=>{
        rows.push([b.eventKey, b.bookingId, b.bookingType, b.description, b.name, b.phone, b.amount, b.status]);
      });
      const csv = rows.map(r => r.map(x => `"${String(x||"").replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `byz-${currentEvent || "all"}-export.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Tabs
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentEvent = btn.dataset.event || "";
        load();
      });
    });

    /* ===================== SCAN MODE LOGIC ===================== */
    let scanOpen = false;
    let camStream = null;
    let scanLoopRunning = false;
    let lastSeen = "";
    let currentBooking = null;
    let currentScanEvent = "groove";

    function openScan(){
      switchView('scan-view');
      scanOpen = true;
    }
    function closeScan(){
      stopScan();
      switchView('dashboard-view');
      scanOpen = false;
    }
    function startScan(){
      if(!scanOpen) openScan();
      startCamera();
    }
    function stopScan(){
      scanLoopRunning = false;
      lastSeen = "";
      currentBooking = null;
      setScanResult("Ready", "Scan a QR or search a Booking ID.", null, false);
      if(camStream){
        camStream.getTracks().forEach(t => t.stop());
        camStream = null;
      }
      const v = document.getElementById("cam");
      if(v) v.srcObject = null;
    }

    async function startCamera(){
      try{
        const v = document.getElementById("cam");
        const canvas = document.getElementById("scanCanvas");
        const ctx = canvas.getContext("2d", { willReadFrequently: true });

        camStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false
        });

        v.srcObject = camStream;
        await v.play();

        scanLoopRunning = true;
        document.getElementById("scanHint").textContent = "Scanning…";

        if("BarcodeDetector" in window){
          const detector = new BarcodeDetector({ formats: ["qr_code"] });

          (async function scanLoop(){
            while(scanLoopRunning){
              try{
                const codes = await detector.detect(v);
                if(codes && codes.length){
                  const raw = (codes[0].rawValue || "").trim();
                  if(raw && raw !== lastSeen){
                    lastSeen = raw;
                    const parsed = parseQr_(raw);
                    if(parsed.bid) await verifyById(parsed.bid, parsed.event || currentScanEvent);
                  }
                }
              }catch(e){}
              await new Promise(r => setTimeout(r, 150));
            }
          })();
          return;
        }

        if(typeof jsQR !== "function"){
          document.getElementById("scanHint").textContent =
            "Camera on, but QR library missing — use Manual Booking ID.";
          return;
        }

        document.getElementById("scanHint").textContent = "Scanning… (Safari mode)";

        (async function scanLoop(){
          while(scanLoopRunning){
            try{
              const w = v.videoWidth;
              const h = v.videoHeight;
              if(!w || !h){ await new Promise(r => setTimeout(r, 120)); continue; }

              canvas.width = w; canvas.height = h;
              ctx.drawImage(v, 0, 0, w, h);
              const img = ctx.getImageData(0, 0, w, h);

              const code = jsQR(img.data, w, h, { inversionAttempts: "dontInvert" });
              if(code && code.data){
                const raw = String(code.data || "").trim();
                if(raw && raw !== lastSeen){
                  lastSeen = raw;
                  const parsed = parseQr_(raw);
                  if(parsed.bid) await verifyById(parsed.bid, parsed.event || currentScanEvent);
                }
              }
            }catch(e){}
            await new Promise(r => setTimeout(r, 220));
          }
        })();

      }catch(err){
        console.error(err);
        alert("Camera blocked. Allow camera permission then try again.");
      }
    }

    function parseQr_(raw){
      try{
        if(raw.includes("bid=")){
          const u = new URL(raw);
          return { bid: u.searchParams.get("bid"), event: u.searchParams.get("event") };
        }
      }catch(e){}
      return { bid: raw, event: "" };
    }

    async function verifyById(bid, eventKey){
      bid = (bid || "").trim();
      if(!bid) return;

      currentScanEvent = eventKey || document.getElementById("scanEvent").value;

      setScanResult("Checking…", "Verifying booking…", null, false);

      try{
        const url = `${SCRIPT_URL}?event=${encodeURIComponent(currentScanEvent)}&bid=${encodeURIComponent(bid)}`;
        const res = await fetch(url).then(r=>r.json());

        if(!res.found){
          setScanResult("❌ Not found", "This booking ID does not exist.", null, false);
          return;
        }

        currentBooking = res.booking;
        const ok = !!res.validForEntry;
        const title = ok ? "✅ Valid for entry" : "❌ Not valid";
        const sub = ok
          ? `Remaining wristbands: ${res.remaining}`
          : (currentBooking.status !== "CONFIRMED" ? "Status is not confirmed." : "No remaining entries.");

        setScanResult(title, sub, res, ok);

      }catch(err){
        console.error(err);
        setScanResult("⚠️ Error", "Could not reach server. Check internet.", null, false);
      }
    }

    function setScanResult(title, subtitle, res, enableButtons){
      const box = document.getElementById("scanResult");
      box.innerHTML = `
        <div class="big">${title}</div>
        <div class="sub">${subtitle}</div>
        ${res ? `
          <div class="meta">
            <div><b>ID:</b> ${res.booking.bookingId}</div>
            <div><b>Name:</b> ${res.booking.name}</div>
            <div><b>Description:</b> ${res.booking.description}</div>
            <div><b>Qty:</b> ${res.booking.quantity} • <b>Checked in:</b> ${res.booking.checkedInCount} • <b>Remaining:</b> ${res.remaining}</div>
            <div><b>Last:</b> ${res.booking.lastCheckInTime || "—"}</div>
            <div><b>Status:</b> <span class="status ${res.booking.status}">${res.booking.status}</span></div>
          </div>
        ` : ``}
      `;

      document.getElementById("btnOne").disabled = !enableButtons;
      document.getElementById("btnAll").disabled = !enableButtons;
    }

    async function checkIn(count){
      if(!currentBooking) return;

      try{
        const payload = {
          action: "checkin",
          bookingId: currentBooking.bookingId,
          count: count,
          pin: ADMIN_PASSWORD,
          eventKey: currentScanEvent
        };

        const res = await fetch(SCRIPT_URL, {
          method:"POST",
          headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        }).then(r=>r.json());

        if(!res.ok){
          setScanResult("❌ Check-in blocked", res.error || "Not allowed.", null, false);
          return;
        }

        const added = (res.added ?? "");
        setScanResult(
          "✅ Check-in complete",
          `Entry recorded${added !== "" ? " (+" + added + ")" : ""}. Ready for next scan.`,
          null,
          false
        );

        currentBooking = null;
        manualBid.value = "";

        setTimeout(() => {
          setScanResult("Ready", "Scan a QR or search a Booking ID.", null, false);
        }, 1200);

        load();

      }catch(err){
        console.error(err);
        setScanResult("⚠️ Error", "Check-in failed. Try again.", null, false);
      }
    }

    document.getElementById("scanEvent").addEventListener("change", (e)=> {
      currentScanEvent = e.target.value;
    });
  </script>
</body>
</html>
